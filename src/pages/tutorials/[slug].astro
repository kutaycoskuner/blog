---
import Layout from "../../layouts/Layout.astro";
import { getToc } from "../../utils/getToc";
import { getEntry, getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import fs from "node:fs";
import path from "node:path";

// Tell TypeScript what MDX files export

// Import all blog posts
const { slug } = Astro.params;
const post = await getEntry("tutorials" as any, slug);

if (!post) {
    return new Response(null, { status: 404 });
}

// Load the post
const { data, render } = post as CollectionEntry<"tutorials">;
const { Content } = await render();
// Build the table of contents (assuming getToc takes a file path)
const baseDir = path.resolve("src/content/tutorials");
const potentialFiles = [
    path.join(baseDir, `${slug}.mdx`),
    path.join(baseDir, `${slug}.md`),
];

// Find the actual file path that exists
let filePath = potentialFiles.find((p) => fs.existsSync(p));

if (!filePath) {
    // Handle the case where neither file is found
    console.error(`Content not found for slug: ${slug}`);
    return;
}

// Now call your custom function with the found path
const postToc = await getToc(filePath);

export async function getStaticPaths() {
    const allPosts = import.meta.glob(`../../content/tutorials/*.{mdx,md}`);

    return Object.keys(allPosts)
        .map((path) => {
            const slug = path
                .split("/")
                .pop()
                // âœ… FIX: Replace EITHER .mdx OR .md at the end of the string
                ?.replace(/\.(mdx|md)$/, "");

            // You should also ensure the slug is valid (not null/undefined)
            if (!slug) return null;

            return { params: { slug } };
        })
        .filter(Boolean); // Filter out any entries that returned null
}

// console.log(post)

function formatDate(date: Date): String {
    const options: any = {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "numeric",
    };
    return new Date(date).toLocaleDateString("en-de", options);
}

function getLanguageDescription(languageCode: string): string {
    const languageMap: Record<string, string> = {
        en: "This content is in English.",
        tr: "This content is in Turkish.",
        de: "This content is in German.",
        // ... add more languages here
    };

    return languageMap[languageCode] ?? "";
}
---

<Layout>
    <div class="main markdown">
        {
            data?.visibility && (
                <article class="article content">
                    <div class="article-meta">
                        <h1>{data.title}</h1>
                        <span>Published : {formatDate(data.created)}</span>
                        <span>
                            Revision : {formatDate(data.updated)}, v
                            {data.revision}{" "}
                        </span>
                        <span>
                            Language : {getLanguageDescription(data.language)}{" "}
                        </span>
                        <a
                            href="#"
                            class="to-pdf"
                        />
                        <img
                            src=""
                            alt=""
                        />
                    </div>
                    <Content />
                </article>
            )
        }
    </div>

    <div class="toc-container no-select">
        {
            data?.visibility && (
                <>
                    <div class="toc-title">
                        <span style="color: var(--col)">
                            <b>{data?.title}</b>
                        </span>
                    </div>

                    {postToc.map((link) => (
                        <span
                            class={`toc-item toc-level-${link.depth}`}
                            style={`margin-left: ${
                                link.depth === 2
                                    ? "0.5em"
                                    : link.depth === 3
                                      ? "1.5em"
                                      : link.depth >= 4
                                        ? "2.5em"
                                        : "0"
                            };`}
                        >
                            <a
                                class="toc-content"
                                href={`#${link.slug}`}
                            >
                                {link.text}
                            </a>
                            <br />
                        </span>
                    ))}
                </>
            )
        }
    </div>
</Layout>

<style>
    @import "../../styles/markdown.css";
</style>
