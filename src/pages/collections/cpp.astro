---
import Layout from "../../layouts/Layout.astro";
import { getToc } from "../../utils/getToc";
import { getCollection } from "astro:content";
import path from "node:path";

interface TocItem {
    depth: number;
    text: string;
    slug?: string;
}

interface PostToc {
    postData: {
        title: string;
        created: Date;
        updated: Date;
        revision: number;
        language: string;
        visibility: boolean;
    };
    toc: TocItem[];
    slug: string; // <-- add this
}

const COLLECTION_NAME: string = "collections/cpp";

const allEntries = await getCollection(COLLECTION_NAME);

const posts = (
    allEntries.filter(
        (entry) => entry.id.endsWith(".md") || entry.id.endsWith(".mdx")
    ) as any[]
) // <-- Temporary type assertion if TypeScript is confused
    .sort((a, b) => {
        // ... sorting logic ...
        const orderA = a.data.sort_order ?? 9999;
        const orderB = b.data.sort_order ?? 9999;
        return orderA - orderB;
    });


if (!posts || posts.length === 0) {
    return new Response(
        "Post not found. Removed, not existed, or work in progress.",
        { status: 404 }
    );
}

const baseDir = path.resolve("src/content/" + COLLECTION_NAME);
const postTocs: PostToc[] = await Promise.all(
    posts.map(async (post) => {
        const filePath = path.join(baseDir, post.id);
        const slug = post.slug ?? post.id.replace(/\.(md|mdx)$/, "");
        return {
            postData: post.data as PostToc["postData"],
            toc: await getToc(filePath),
            slug,
        };
    })
);

function formatDate(date: Date): string {
    return new Date(date).toLocaleDateString("en-de", {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "numeric",
    });
}

function getLanguageDescription(languageCode: string): string {
    const languageMap: Record<string, string> = {
        en: "This content is in English.",
        tr: "This content is in Turkish.",
        de: "This content is in German.",
    };
    return languageMap[languageCode] ?? "";
}

---

<Layout>
    <div class="main markdown">
        {
            await Promise.all(
                posts.map(async (post) => {
                    const { Content } = await post.render();
                    const postData = post.data;
                    if (!postData.visibility) return null;

                    return (
                        <article
                            class="article content"
                            id={post.slug}
                        >
                            <div class="article-meta">
                                <h1>{postData.title}</h1>
                                <span>
                                    Published: {formatDate(postData.created)}
                                </span>
                                <span>
                                    Revision: {formatDate(postData.updated)}, v
                                    {postData.revision}
                                </span>
                                <span>
                                    Language:{" "}
                                    {getLanguageDescription(postData.language)}
                                </span>
                            </div>
                            <Content />
                        </article>
                    );
                })
            )
        }
    </div>

    <div class="toc-container no-select">
        {
            postTocs.map(({ postData, toc, slug }) => {
                if (!postData.visibility) return null;
                return (
                    <div
                        class="toc-article"
                        data-slug={slug}
                    >
                        <div class="toc-title">
                            <span style="color: var(--col)">
                                <b>{postData.title}</b>
                            </span>
                        </div>

                        <div
                            class="toc-sections"
                            data-slug={slug}
                        >
                            {toc.map((link) => (
                                <span
                                    class={`toc-item toc-level-${link.depth}`}
                                    style={`margin-left: ${
                                        link.depth === 2
                                            ? "0.5em"
                                            : link.depth === 3
                                              ? "1.5em"
                                              : link.depth >= 4
                                                ? "2.5em"
                                                : "0"
                                    };`}
                                >
                                    <a
                                        class="toc-content"
                                        href={`#${link.slug}`}
                                    >
                                        {link.text}
                                    </a>
                                    <br />
                                </span>
                            ))}
                        </div>
                    </div>
                );
            })
        }
    </div>

    <script is:inline>
        let activeArticle = null;

        const articles = document.querySelectorAll("article");
        const tocSections = document.querySelectorAll(".toc-sections");
        const tocTitles = document.querySelectorAll(".toc-title");

        // Show/hide TOC sections on mouse enter
        articles.forEach((article) => {
            article.addEventListener("mouseenter", () => {
                activeArticle = article.id;
                tocSections.forEach((section) => {
                    section.style.display =
                        section.dataset.slug === activeArticle
                            ? "block"
                            : "none";
                });
            });
        });

        // Click TOC title to scroll & set active article
        tocTitles.forEach((title) => {
            title.addEventListener("click", () => {
                const slug = title.parentElement.dataset.slug;
                const targetArticle = document.getElementById(slug);
                if (!targetArticle) return;

                // scroll to top of the article
                targetArticle.scrollIntoView({ behavior: "smooth" });

                // set active article
                activeArticle = slug;
                tocSections.forEach((section) => {
                    section.style.display =
                        section.dataset.slug === activeArticle
                            ? "block"
                            : "none";
                });
            });
        });

        // Smooth scroll for TOC links
        document.querySelectorAll(".toc-content").forEach((link) => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                const target = document.getElementById(
                    link.getAttribute("href").substring(1)
                );
                target?.scrollIntoView({ behavior: "smooth" });
            });
        });
    </script>
</Layout>

<style>
    @import "../../styles/markdown.css";
    .toc-sections {
        display: none;
    }
</style>
